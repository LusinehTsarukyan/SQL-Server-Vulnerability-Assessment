package Vul.controllers;

import Vul.SqlConnection;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;

@Controller
public class MainController {
    String url;
    String user;
    String password;

    @RequestMapping(value = "/main", method = RequestMethod.GET)
    String showMainPage(ModelMap model) {
        return "main";
    }

    @RequestMapping(value = "/connect", method = RequestMethod.POST)
    String connect(ModelMap model,
                   @RequestParam String system,
                   @RequestParam String address,
                   @RequestParam String database,
                   @RequestParam String user,
                   @RequestParam String password) {

        if (system.equals("SQL Server")) {
            system = "jdbc:sqlserver";
        } else {
            model.put("msg", "The System supports only SQL Server yet. Try again.");
        }
        try (Connection conn = SqlConnection.ConnectDB(system + "://" + address + ";" + "database=" + database, user, password)) {
            url = system + "://" + address + ";" + "database=" + database;
            this.user = user;
            this.password = password;
            model.put("msg", "Connected to database " + database + " successfully.");
        } catch (SQLException e) {
            model.put("msg", "Not Valid Input. Try again.");
        }
        return "msg";
    }

    @RequestMapping(value = "/helpFile", method = RequestMethod.GET)
    String sp_helpFile(ModelMap model) {
        List<String> resultList = new ArrayList<>();

            try (Connection conn = SqlConnection.ConnectDB(url,user,password)) {
                Statement st = null;
                if (conn != null) {
                    st = conn.createStatement();
                }

                // execute the query, and get a java resultset
                ResultSet rs = null; //"select * from syslogins");
                if (st != null) {
                    rs = st.executeQuery("sp_helpfile");
                }
                ResultSetMetaData rsmd = null;
                if (rs != null) {
                    rsmd = rs.getMetaData();
                }
                int columnsNumber = 0;
                if (rsmd != null) {
                    columnsNumber = rsmd.getColumnCount();
                }
                if (rs != null) {
                    while (rs.next()) {
                        for (int i = 1; i <= columnsNumber; i++) {
                            if (i > 1) System.out.print(",  ");
                            String columnValue = rs.getString(i);
                            resultList.add(columnValue);
                            System.out.print(columnValue + " " + rsmd.getColumnName(i));
                        }
                        model.put("resultList", resultList);
                    }
                }
            } catch (SQLException e) {
                model.put("error", "Problem with connecting to database.");
                return "error";
            }
        return "sp_helpFile";
        }
    }
